<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Прототип ИС закупок</title>
    <meta
      name="description"
      content="Клиентский прототип автоматизации процесса организации и контроля поставки."
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;700;800&family=PT+Sans:wght@400;700&display=swap"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@quasar/extras/material-icons/material-icons.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/quasar@2.18.5/dist/quasar.prod.css"
    />
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <div id="q-app">
      <q-layout view="lHh Lpr lFf">
        <q-header elevated class="header-shell">
          <q-toolbar class="q-px-md q-py-sm">
            <q-toolbar-title>
              <div class="text-weight-bold text-h6">Прототип ИС закупок</div>
              <div class="text-caption header-caption">
                To-Be процесс: заявка -> проверка -> заказ -> оплата -> поставка -> закрытие
              </div>
            </q-toolbar-title>
            <q-select
              dense
              outlined
              class="role-select"
              bg-color="white"
              emit-value
              map-options
              v-model="currentRole"
              :options="roleOptions"
              label="Текущая роль"
            />
            <q-btn
              flat
              icon="restart_alt"
              color="white"
              class="q-ml-sm"
              label="Сбросить демо-данные"
              @click="resetDemoData"
            />
          </q-toolbar>
          <q-tabs
            v-model="activeTab"
            dense
            align="left"
            active-color="secondary"
            indicator-color="secondary"
            class="q-px-sm"
          >
            <q-tab name="process" label="Процесс и заявки" icon="account_tree" />
            <q-tab name="suppliers" label="Поставщики" icon="domain" />
            <q-tab name="products" label="Товары" icon="inventory_2" />
            <q-tab name="guide" label="To-Be карта" icon="map" />
          </q-tabs>
        </q-header>

        <q-page-container>
          <q-page class="q-pa-md app-bg">
            <div v-if="activeTab === 'process'" class="fade-in">
              <div class="row q-col-gutter-md q-mb-md">
                <div class="col-12 col-sm-6 col-lg-3" v-for="card in dashboardCards" :key="card.key">
                  <q-card class="stat-card">
                    <q-card-section>
                      <div class="text-caption">{{ card.label }}</div>
                      <div class="text-h4 text-weight-bold">{{ card.value }}</div>
                      <div class="text-caption text-grey-7">{{ card.caption }}</div>
                    </q-card-section>
                  </q-card>
                </div>
              </div>

              <div class="row q-col-gutter-md">
                <div class="col-12 col-xl-5">
                  <q-card class="panel-card">
                    <q-card-section class="row q-col-gutter-sm items-center">
                      <div class="col-12 col-md-5">
                        <q-input
                          dense
                          outlined
                          v-model.trim="requestSearch"
                          label="Поиск заявки"
                          clearable
                          debounce="200"
                        >
                          <template #prepend>
                            <q-icon name="search" />
                          </template>
                        </q-input>
                      </div>
                      <div class="col-12 col-md-4">
                        <q-select
                          dense
                          outlined
                          emit-value
                          map-options
                          v-model="statusFilter"
                          :options="statusOptions"
                          label="Статус"
                        />
                      </div>
                      <div class="col-12 col-md-3">
                        <q-btn
                          color="primary"
                          icon="add"
                          class="full-width"
                          label="Новая заявка"
                          @click="openCreateDialog"
                        />
                      </div>
                    </q-card-section>
                    <q-separator />
                    <q-table
                      flat
                      dense
                      row-key="id"
                      :rows="filteredRequests"
                      :columns="requestColumns"
                      :pagination="{ rowsPerPage: 6 }"
                      :rows-per-page-options="[6, 12, 24]"
                      @row-click="onRequestRowClick"
                    >
                      <template #body-cell-status="props">
                        <q-td :props="props">
                          <q-chip dense :color="statusMeta[props.row.status].color" text-color="white">
                            {{ statusMeta[props.row.status].label }}
                          </q-chip>
                        </q-td>
                      </template>
                      <template #body-cell-supplier="props">
                        <q-td :props="props">
                          {{ supplierName(props.row.supplierId) }}
                        </q-td>
                      </template>
                      <template #body-cell-total="props">
                        <q-td :props="props">
                          {{ formatMoney(requestTotal(props.row)) }}
                        </q-td>
                      </template>
                      <template #body-cell-plannedDeliveryDate="props">
                        <q-td :props="props">
                          <div>{{ formatDate(props.row.plannedDeliveryDate) }}</div>
                          <div
                            class="text-caption"
                            :class="isOverdue(props.row) ? 'text-negative' : 'text-grey-6'"
                          >
                            {{ deliveryHint(props.row) }}
                          </div>
                        </q-td>
                      </template>
                      <template #no-data>
                        <div class="q-pa-md text-grey-7">Заявки не найдены.</div>
                      </template>
                    </q-table>
                  </q-card>
                </div>

                <div class="col-12 col-xl-7">
                  <q-card v-if="selectedRequest" class="panel-card">
                    <q-card-section class="row items-start q-col-gutter-md">
                      <div class="col-12 col-lg-8">
                        <div class="text-h6">{{ selectedRequest.id }}</div>
                        <div class="text-caption text-grey-7">
                          Подразделение: {{ selectedRequest.department }} | Инициатор:
                          {{ selectedRequest.initiator }}
                        </div>
                        <div class="text-caption text-grey-7">
                          Поставщик: {{ supplierName(selectedRequest.supplierId) }}
                        </div>
                        <div class="text-caption text-grey-7">
                          Плановая дата поставки: {{ formatDate(selectedRequest.plannedDeliveryDate) }}
                        </div>
                      </div>
                      <div class="col-12 col-lg-4 text-right">
                        <q-chip :color="statusMeta[selectedRequest.status].color" text-color="white">
                          {{ statusMeta[selectedRequest.status].label }}
                        </q-chip>
                        <div class="text-subtitle2 q-mt-sm">
                          Сумма: {{ formatMoney(requestTotal(selectedRequest)) }}
                        </div>
                        <div class="text-caption text-grey-6">
                          Обновлено: {{ formatDateTime(selectedRequest.updatedAt) }}
                        </div>
                      </div>
                    </q-card-section>

                    <q-separator />
                    <q-card-section>
                      <div class="text-subtitle2 q-mb-sm">Доступные действия</div>
                      <div class="q-gutter-sm">
                        <q-btn
                          v-for="action in availableActions(selectedRequest)"
                          :key="action.key"
                          :label="action.label"
                          :icon="action.icon"
                          :color="action.color"
                          :disable="action.disabled"
                          @click="runAction(action.key, selectedRequest)"
                        >
                          <q-tooltip v-if="action.disabled">{{ action.disabledReason }}</q-tooltip>
                        </q-btn>
                      </div>
                    </q-card-section>

                    <q-card-section v-if="selectedRequest.validationErrors && selectedRequest.validationErrors.length">
                      <q-banner dense rounded class="bg-red-1 text-negative">
                        <div class="text-subtitle2 q-mb-xs">Найдены ошибки в заявке</div>
                        <ul class="q-pl-md q-my-xs">
                          <li v-for="err in selectedRequest.validationErrors" :key="err">{{ err }}</li>
                        </ul>
                      </q-banner>
                    </q-card-section>

                    <q-card-section class="q-pt-none">
                      <div class="text-subtitle2 q-mb-sm">Движение по To-Be процессу</div>
                      <q-list bordered separator class="rounded-borders">
                        <q-item v-for="step in processSteps" :key="step.code">
                          <q-item-section avatar>
                            <q-icon :name="stepIcon(selectedRequest, step)" :color="stepColor(selectedRequest, step)" />
                          </q-item-section>
                          <q-item-section>
                            <q-item-label>{{ step.index }}. {{ step.title }}</q-item-label>
                            <q-item-label caption>{{ step.role }}</q-item-label>
                          </q-item-section>
                          <q-item-section side>
                            <q-chip dense :color="stepColor(selectedRequest, step)" text-color="white">
                              {{ stepStateLabel(selectedRequest, step) }}
                            </q-chip>
                          </q-item-section>
                        </q-item>
                      </q-list>
                    </q-card-section>

                    <q-card-section class="q-pt-none">
                      <div class="text-subtitle2 q-mb-sm">Состав заявки</div>
                      <q-markup-table dense flat bordered>
                        <thead>
                          <tr>
                            <th class="text-left">Товар</th>
                            <th class="text-left">Ед.</th>
                            <th class="text-right">Кол-во</th>
                            <th class="text-right">Цена</th>
                            <th class="text-right">Сумма</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr v-for="line in selectedRequestLines" :key="line.productId">
                            <td>{{ line.name }}</td>
                            <td>{{ line.unit }}</td>
                            <td class="text-right">{{ line.qty }}</td>
                            <td class="text-right">{{ formatMoney(line.price) }}</td>
                            <td class="text-right">{{ formatMoney(line.qty * line.price) }}</td>
                          </tr>
                        </tbody>
                      </q-markup-table>
                    </q-card-section>

                    <q-card-section class="q-pt-none">
                      <div class="text-subtitle2 q-mb-sm">История</div>
                      <q-timeline color="primary" layout="dense">
                        <q-timeline-entry
                          v-for="entry in selectedHistory"
                          :key="entry.at + entry.action"
                          :title="entry.action"
                          :subtitle="formatDateTime(entry.at)"
                          icon="history"
                        >
                          <div class="text-caption">
                            {{ entry.actor }}
                            <span v-if="entry.note"> | {{ entry.note }}</span>
                          </div>
                        </q-timeline-entry>
                      </q-timeline>
                    </q-card-section>
                  </q-card>

                  <q-card v-else class="panel-card">
                    <q-card-section>
                      <div class="text-h6">Выберите заявку</div>
                      <div class="text-body2 text-grey-7">
                        В таблице слева выберите заявку, чтобы увидеть маршрут по to-be процессу и
                        выполнить очередной шаг.
                      </div>
                    </q-card-section>
                  </q-card>
                </div>
              </div>
            </div>

            <div v-else-if="activeTab === 'suppliers'" class="fade-in">
              <q-card class="panel-card">
                <q-card-section class="row q-col-gutter-sm items-center">
                  <div class="col-12 col-md-4">
                    <q-input dense outlined v-model.trim="supplierSearch" label="Поиск поставщика" clearable>
                      <template #prepend>
                        <q-icon name="search" />
                      </template>
                    </q-input>
                  </div>
                  <div class="col-12 col-md-8 text-right text-caption text-grey-7">
                    Каталог используется при формировании заказа и расчете срока поставки.
                  </div>
                </q-card-section>
                <q-separator />
                <q-table
                  flat
                  row-key="id"
                  :rows="filteredSuppliers"
                  :columns="supplierColumns"
                  :pagination="{ rowsPerPage: 8 }"
                >
                  <template #body-cell-rating="props">
                    <q-td :props="props">
                      <q-rating
                        size="18px"
                        :model-value="props.row.rating"
                        max="5"
                        color="secondary"
                        readonly
                      />
                    </q-td>
                  </template>
                </q-table>
              </q-card>
            </div>

            <div v-else-if="activeTab === 'products'" class="fade-in">
              <q-card class="panel-card">
                <q-card-section class="row q-col-gutter-sm items-center">
                  <div class="col-12 col-md-4">
                    <q-input dense outlined v-model.trim="productSearch" label="Поиск товара" clearable>
                      <template #prepend>
                        <q-icon name="search" />
                      </template>
                    </q-input>
                  </div>
                  <div class="col-12 col-md-4">
                    <q-select
                      dense
                      outlined
                      emit-value
                      map-options
                      v-model="productSupplierFilter"
                      :options="productSupplierOptions"
                      label="Поставщик"
                    />
                  </div>
                  <div class="col-12 col-md-4 text-right text-caption text-grey-7">
                    Товары привязаны к поставщикам для имитации выбора в заявке.
                  </div>
                </q-card-section>
                <q-separator />
                <q-table
                  flat
                  row-key="id"
                  :rows="filteredProducts"
                  :columns="productColumns"
                  :pagination="{ rowsPerPage: 10 }"
                >
                  <template #body-cell-supplier="props">
                    <q-td :props="props">{{ supplierName(props.row.supplierId) }}</q-td>
                  </template>
                  <template #body-cell-price="props">
                    <q-td :props="props">{{ formatMoney(props.row.price) }}</q-td>
                  </template>
                </q-table>
              </q-card>
            </div>

            <div v-else class="fade-in">
              <q-card class="panel-card">
                <q-card-section>
                  <div class="text-h6 q-mb-sm">Карта To-Be процесса в прототипе</div>
                  <q-list bordered separator>
                    <q-item v-for="step in processSteps" :key="step.code">
                      <q-item-section avatar>
                        <q-avatar color="primary" text-color="white">{{ step.index }}</q-avatar>
                      </q-item-section>
                      <q-item-section>
                        <q-item-label>{{ step.title }}</q-item-label>
                        <q-item-label caption>{{ step.role }}</q-item-label>
                      </q-item-section>
                    </q-item>
                  </q-list>
                </q-card-section>
                <q-card-section class="q-pt-none text-body2 text-grey-8">
                  Прототип полностью клиентский: все данные хранятся в браузере (`localStorage`), а
                  переходы между статусами управляются кнопками по ролям.
                </q-card-section>
              </q-card>
            </div>
          </q-page>
        </q-page-container>
      </q-layout>

      <q-dialog v-model="requestDialog.open" persistent>
        <q-card class="dialog-card">
          <q-card-section class="row items-center q-pb-none">
            <div class="text-h6">
              {{ requestDialog.isEdit ? 'Редактирование заявки' : 'Создание заявки' }}
            </div>
            <q-space />
            <q-btn icon="close" flat round dense v-close-popup />
          </q-card-section>
          <q-card-section>
            <div class="row q-col-gutter-md">
              <div class="col-12 col-md-6">
                <q-input outlined dense v-model.trim="form.department" label="Подразделение-заказчик *" />
              </div>
              <div class="col-12 col-md-6">
                <q-input outlined dense v-model.trim="form.initiator" label="Инициатор *" />
              </div>
              <div class="col-12 col-md-6">
                <q-select
                  outlined
                  dense
                  emit-value
                  map-options
                  v-model="form.supplierId"
                  :options="supplierOptions"
                  label="Поставщик *"
                />
              </div>
              <div class="col-12 col-md-3">
                <q-input
                  outlined
                  dense
                  type="date"
                  v-model="form.plannedDeliveryDate"
                  label="План поставки *"
                />
              </div>
              <div class="col-12 col-md-3">
                <q-input
                  outlined
                  dense
                  type="number"
                  min="0"
                  v-model.number="form.budgetLimit"
                  label="Бюджет, ₽ *"
                />
              </div>
              <div class="col-12">
                <q-input
                  outlined
                  autogrow
                  dense
                  type="textarea"
                  v-model.trim="form.justification"
                  label="Обоснование закупки *"
                />
              </div>
            </div>

            <div class="text-subtitle2 q-mt-md q-mb-sm">Позиции заявки</div>
            <div
              v-for="(item, index) in form.items"
              :key="'form-item-' + index"
              class="row q-col-gutter-sm items-center q-mb-sm"
            >
              <div class="col-12 col-md-7">
                <q-select
                  dense
                  outlined
                  emit-value
                  map-options
                  v-model="item.productId"
                  :options="formProductOptions"
                  label="Товар *"
                />
              </div>
              <div class="col-5 col-md-2">
                <q-input dense outlined type="number" min="1" v-model.number="item.qty" label="Кол-во *" />
              </div>
              <div class="col-5 col-md-2">
                <q-input
                  dense
                  outlined
                  :model-value="formatMoney(formItemAmount(item))"
                  label="Сумма"
                  readonly
                />
              </div>
              <div class="col-2 col-md-1 text-right">
                <q-btn
                  flat
                  round
                  icon="delete"
                  color="negative"
                  @click="removeFormItem(index)"
                  :disable="form.items.length === 1"
                />
              </div>
            </div>

            <div class="row items-center q-mt-sm">
              <q-btn flat color="primary" icon="add" label="Добавить позицию" @click="addFormItem" />
              <q-space />
              <div class="text-subtitle1 text-weight-bold">Итого: {{ formatMoney(formTotal) }}</div>
            </div>
          </q-card-section>
          <q-card-actions align="right">
            <q-btn flat label="Отмена" color="grey-8" v-close-popup />
            <q-btn color="primary" label="Сохранить" @click="saveRequestFromDialog" />
          </q-card-actions>
        </q-card>
      </q-dialog>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quasar@2.18.5/dist/quasar.umd.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quasar@2.18.5/dist/lang/ru.umd.prod.js"></script>
    <script src="./app.js"></script>
  </body>
</html>
